<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presupuesto - AXENTIA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #D9DAD4;
            margin: 0;
            padding: 0;
            color: #303030;
        }

        header {
            background: #303030;
            color: #F5F1E8;
            padding: 20px;
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 2px;
            position: relative;
        }

        .switch-container {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #F5F1E8;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #BEA167;
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }

        main {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        section {
            background: #F5F1E8;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        section h2 {
            margin-top: 0;
            font-size: 1.2rem;
            color: #BEA167;
            border-bottom: 2px solid #BEA167;
            padding-bottom: 5px;
        }

        label {
            display: block;
            margin-top: 12px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #303030;
        }

        input,
        select {
            width: calc(100% - 16px);
            padding: 10px;
            margin: 6px 0 14px 0;
            border-radius: 10px;
            border: 1px solid #ccc;
            background: #fff;
            font-size: 0.95rem;
        }

        button {
            margin-top: 10px;
            padding: 10px 15px;
            border: none;
            background: #BEA167;
            color: #303030;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        button:hover {
            background: #303030;
            color: #F5F1E8;
        }

        table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        table th,
        table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ccc;
        }

        table th {
            background: #303030;
            color: #F5F1E8;
        }

        table tbody tr:nth-child(even) {
            background: #f0f0f0;
        }

        .btn-eliminar {
            background: none;
            border: none;
            color: #BEA167;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .btn-eliminar:hover {
            color: #7a643e;
        }

        #resultado {
            margin: 20px;
            padding: 15px;
            background: #F5F1E8;
            border-radius: 10px;
            border: 1px solid #BEA167;
        }

        /* --- TABLA DE TOTALES EN VISTA HTML --- */
        #tabla_totales {
            margin-left: auto;
            margin-top: 20px;
            border-collapse: collapse;
            width: auto;
            font-size: 1rem;
        }

        #tabla_totales td {
            border: 1px solid #ccc;
            padding: 8px 14px;
        }

        #tabla_totales tr:nth-child(1),
        #tabla_totales tr:nth-child(2) {
            background: #F5F1E8;
            color: #303030;
        }

        #tabla_totales tr:last-child {
            background: #BEA167;
            color: white;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <header>
        <span id="header_nombre">AXENTIA</span>
        <div class="switch-container">
            <span>AX</span>
            <label class="switch">
                <input type="checkbox" id="empresa_toggle" onchange="cambiarEmpresa()">
                <span class="slider"></span>
            </label>
            <span>MDP</span>
        </div>
    </header>

    <main>
        <!-- Empresa -->
        <section>
            <h2>Datos de la Empresa</h2>
            <label>Nombre</label>
            <input type="text" id="empresa_nombre" value="AXENTIA" readonly>
            <label>CUIT</label>
            <input type="text" id="empresa_cuit" value="30-71902891-4" readonly>
            <label>Dirección</label>
            <input type="text" id="empresa_direccion" value="Sarmiento 24" readonly>
            <label>Email</label>
            <input type="email" id="empresa_mail" value="adm.axentia@gmail.com " readonly>
            <label>Teléfono</label>
            <input type="text" id="empresa_tel" value="+54 9 3364 24-9663" readonly>
        </section>

        <!-- Cliente -->
        <section>
            <h2>Datos del Cliente</h2>
            <label>Nombre</label>
            <input type="text" id="cliente_nombre">
            <label>CUIT</label>
            <input type="text" id="cliente_cuit">
            <label>Dirección</label>
            <input type="text" id="cliente_direccion">
            <label>Email</label>
            <input type="email" id="cliente_mail">
        </section>

        <!-- Presupuesto -->
        <section>
            <h2>Datos del Presupuesto</h2>
            <label>Moneda</label>
            <select id="moneda" onchange="actualizarTabla(this.value)">
                <option value="USD">Dólar (USD)</option>
                <option value="EUR">Euro (EUR)</option>
                <option value="ARS">Peso Argentino (ARS)</option>
            </select>
            <label>Fecha</label>
            <input type="date" id="fecha">
            <label>Validez (días)</label>
            <input type="number" id="validez" min="1" placeholder="Ej: 30">
            <label>Forma de pago</label>
            <select id="pago">
                <option>Efectivo</option>
                <option>Cuenta Corriente</option>
                <option>Transferencia</option>
                <option>Cheque</option>
            </select>
        </section>
    </main>

    <!-- Productos -->
    <section style="margin:20px;">
        <h2>Productos</h2>
        <input type="text" id="producto_desc" placeholder="Descripción">
        <input type="number" id="producto_cant" placeholder="Cantidad" min="1">
        <input type="number" id="producto_precio" placeholder="Precio unitario" min="0" step="0.01">
        <input type="number" id="producto_iva" placeholder="IVA (%)" value="10.5" min="0" max="100">
        <button onclick="agregarProducto()">Agregar producto</button>

        <table id="tabla_productos">
            <thead>
                <tr>
                    <th>Descripción</th>
                    <th>Cant</th>
                    <th>Precio Base</th>
                    <th>Sub-Tot Base</th>
                    <th>IVA (%)</th>
                    <th>Total IVA</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- Totales en tabla -->
        <table id="tabla_totales">
            <tr>
                <td>Total Neto:</td>
                <td><span id="total">0</span> <span id="simbolo_moneda">USD</span></td>
            </tr>
            <tr>
                <td>Total IVA:</td>
                <td><span id="iva_total">0</span> <span id="simbolo_moneda">USD</span></td>
            </tr>
            <tr>
                <td>Total Final:</td>
                <td><span id="total_final">0</span> <span id="simbolo_moneda">USD</span></td>
            </tr>
        </table>
    </section>

    <div style="text-align:center;">
        <button onclick="generarPresupuesto()">Generar Presupuesto</button>
        <button onclick="descargarPDF()">Descargar PDF</button>
    </div>

    <div id="resultado"></div>

    <script>
        let productos = [];

        function cambiarEmpresa() {
            const toggle = document.getElementById("empresa_toggle");
            const header = document.getElementById("header_nombre");
            const inputNombre = document.getElementById("empresa_nombre");
            const inputCuit = document.getElementById("empresa_cuit");
            if (toggle.checked) {
                header.innerText = "MDP SOLUCIONES";
                inputNombre.value = "MDP SOLUCIONES";
                inputCuit.value = "20-35023798-5";
            } else {
                header.innerText = "AXENTIA";
                inputNombre.value = "AXENTIA";
                inputCuit.value = "30-71902891-4";
            }
        }

        function agregarProducto() {
            const desc = document.getElementById("producto_desc").value;
            const cant = parseInt(document.getElementById("producto_cant").value);
            const precio = parseFloat(document.getElementById("producto_precio").value);
            const ivaPorc = parseFloat(document.getElementById("producto_iva").value) || 0;
            const moneda = document.getElementById("moneda").value;
            if (!desc || isNaN(cant) || isNaN(precio)) return;
            const subTotalBase = cant * precio;
            const totalIVA = subTotalBase * ivaPorc / 100;
            productos.push({ desc, cant, precio, subTotalBase, ivaPorc, totalIVA });
            actualizarTabla(moneda);
            document.getElementById("producto_desc").value = "";
            document.getElementById("producto_cant").value = "";
            document.getElementById("producto_precio").value = "";
            document.getElementById("producto_iva").value = "10.5";
        }

        function actualizarTabla(moneda) {
            const tbody = document.querySelector("#tabla_productos tbody");
            tbody.innerHTML = "";
            let total = 0, totalIVA = 0;
            productos.forEach((p, index) => {
                total += p.subTotalBase;
                totalIVA += p.totalIVA;
                tbody.innerHTML += `
          <tr>
            <td>${p.desc}</td>
            <td>${p.cant}</td>
            <td>${p.precio.toFixed(2)} ${moneda}</td>
            <td>${p.subTotalBase.toFixed(2)} ${moneda}</td>
            <td>${p.ivaPorc}%</td>
            <td>${p.totalIVA.toFixed(2)} ${moneda}</td>
            <td><button class="btn-eliminar" onclick="eliminarProducto(${index})">🗑</button></td>
          </tr>`;
            });
            const totalFinal = total + totalIVA;
            document.getElementById("total").innerText = total.toFixed(2);
            document.getElementById("iva_total").innerText = totalIVA.toFixed(2);
            document.getElementById("total_final").innerText = totalFinal.toFixed(2);
            document.querySelectorAll("#simbolo_moneda").forEach(el => el.innerText = moneda);
        }

        function eliminarProducto(i) {
            productos.splice(i, 1);
            actualizarTabla(document.getElementById("moneda").value);
        }


        function generarPresupuesto() {
            const empresa = {
                nombre: document.getElementById("empresa_nombre").value,
                cuit: document.getElementById("empresa_cuit").value,
                direccion: document.getElementById("empresa_direccion").value,
                mail: document.getElementById("empresa_mail").value,
                tel: document.getElementById("empresa_tel").value
            };
            const cliente = {
                nombre: document.getElementById("cliente_nombre").value,
                cuit: document.getElementById("cliente_cuit").value,
                direccion: document.getElementById("cliente_direccion").value,
                mail: document.getElementById("cliente_mail").value
            };
            const presupuesto = {
                moneda: document.getElementById("moneda").value,
                fecha: document.getElementById("fecha").value,
                validez: document.getElementById("validez").value,
                pago: document.getElementById("pago").value
            };

            if (presupuesto.validez < 1) {
                alert("La validez no puede ser menor a 1 día");
                return;
            }

            let html = `
    <h2>Presupuesto</h2>
    <p><b>Empresa:</b> ${empresa.nombre} (CUIT: ${empresa.cuit})<br>
       ${empresa.direccion}<br>
       ${empresa.mail} - ${empresa.tel}</p>

    <p><b>Cliente:</b> ${cliente.nombre} (CUIT: ${cliente.cuit})<br>
       ${cliente.direccion}<br>
       ${cliente.mail}</p>

    <p><b>Fecha:</b> ${presupuesto.fecha}<br>
       <b>Validez:</b> ${presupuesto.validez} días<br>
       <b>Forma de pago:</b> ${presupuesto.pago}</p>

    <table border="1" cellpadding="5" cellspacing="0" width="100%">
      <thead>
        <tr>
          <th>Descripción</th>
          <th>Cant</th>
          <th>Precio Base</th>
          <th>Sub-Tot Base</th>
          <th>IVA (%)</th>
          <th>Total IVA</th>
        </tr>
      </thead>
      <tbody>
  `;

            productos.forEach(p => {
                html += `
      <tr>
        <td>${p.desc}</td>
        <td>${p.cant}</td>
        <td>${p.precio.toFixed(2)} ${presupuesto.moneda}</td>
        <td>${p.subTotalBase.toFixed(2)} ${presupuesto.moneda}</td>
        <td>${p.ivaPorc}%</td>
        <td>${p.totalIVA.toFixed(2)} ${presupuesto.moneda}</td>
      </tr>
    `;
            });

            html += `
      </tbody>
    </table>

    <table id="tabla_totales">
      <tr><td>Total Neto:</td><td>${document.getElementById("total").innerText} ${presupuesto.moneda}</td></tr>
      <tr><td>Total IVA:</td><td>${document.getElementById("iva_total").innerText} ${presupuesto.moneda}</td></tr>
      <tr><td>Total Final:</td><td>${document.getElementById("total_final").innerText} ${presupuesto.moneda}</td></tr>
    </table>
  `;

            document.getElementById("resultado").innerHTML = html;
        }


        /* PDF igual que antes */
        function descargarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.width;
            const empresa = {
                nombre: document.getElementById("empresa_nombre").value,
                cuit: document.getElementById("empresa_cuit").value,
                direccion: document.getElementById("empresa_direccion").value,
                mail: document.getElementById("empresa_mail").value,
                tel: document.getElementById("empresa_tel").value
            };
            const cliente = {
                nombre: document.getElementById("cliente_nombre").value,
                cuit: document.getElementById("cliente_cuit").value,
                direccion: document.getElementById("cliente_direccion").value,
                mail: document.getElementById("cliente_mail").value
            };
            const presupuesto = {
                moneda: document.getElementById("moneda").value,
                fecha: document.getElementById("fecha").value,
                validez: document.getElementById("validez").value,
                pago: document.getElementById("pago").value
            };

            doc.setFontSize(18);
            doc.text("Presupuesto", 14, 20);
            doc.setFontSize(12);
            doc.text(`Empresa: ${empresa.nombre}`, 14, 30);
            doc.text(`CUIT: ${empresa.cuit}`, 14, 36);
            doc.text(`${empresa.direccion}`, 14, 42);
            doc.text(`${empresa.mail} - ${empresa.tel}`, 14, 48);
            doc.text(`Cliente: ${cliente.nombre}`, 14, 58);
            doc.text(`CUIT: ${cliente.cuit}`, 14, 64);
            doc.text(`${cliente.direccion}`, 14, 70);
            doc.text(`${cliente.mail}`, 14, 76);
            doc.text(`Fecha: ${presupuesto.fecha}`, 14, 86);
            doc.text(`Validez: ${presupuesto.validez} días`, 14, 92);
            doc.text(`Forma de pago: ${presupuesto.pago}`, 14, 98);

            const rows = productos.map(p => [
                p.desc,
                p.cant,
                p.precio.toFixed(2) + " " + presupuesto.moneda,
                p.subTotalBase.toFixed(2) + " " + presupuesto.moneda,
                p.ivaPorc + "%",
                p.totalIVA.toFixed(2) + " " + presupuesto.moneda
            ]);
            doc.autoTable({
                startY: 110,
                head: [["Descripción", "Cant", "Precio Base", "Sub-Tot Base", "IVA (%)", "Total IVA"]],
                body: rows,
                styles: { halign: "center" },
                headStyles: { fillColor: [48, 48, 48], textColor: [245, 241, 232] }
            });

            let finalY = doc.lastAutoTable.finalY + 10;
            const totalData = [
                ["Total Neto:", `${document.getElementById("total").innerText} ${presupuesto.moneda}`],
                ["Total IVA:", `${document.getElementById("iva_total").innerText} ${presupuesto.moneda}`],
                ["Total Final:", `${document.getElementById("total_final").innerText} ${presupuesto.moneda}`]
            ];
            const col1Width = Math.max(...totalData.map(r => doc.getTextWidth(r[0]))) + 6;
            const col2Width = Math.max(...totalData.map(r => doc.getTextWidth(r[1]))) + 6;
            const tableWidth = col1Width + col2Width;
            const marginLeft = pageWidth - tableWidth - 14;
            doc.autoTable({
                startY: finalY,
                body: totalData,
                theme: "grid",
                styles: { halign: "right", fillColor: [245, 241, 232], textColor: [48, 48, 48] },
                margin: { left: marginLeft },
                tableWidth: "wrap",
                columnStyles: {
                    0: { halign: "right", cellWidth: col1Width },
                    1: { halign: "right", cellWidth: col2Width }
                },
                head: [],
                didParseCell: function (data) {
                    if (data.row.index === 2) {
                        data.cell.styles.fillColor = [190, 161, 103];
                        data.cell.styles.textColor = 255;
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            doc.save("presupuesto.pdf");
        }
    </script>
</body>

</html>