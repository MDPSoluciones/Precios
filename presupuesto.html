<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Presupuesto - AXENTIA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #D9DAD4;
            margin: 0;
            padding: 0;
            color: #303030;
        }

        header {
            background: #303030;
            color: #F5F1E8;
            padding: 20px;
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            position: relative;
        }

        .switch-container {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 0.9rem;
            color: #F5F1E8;
        }

        .switch {
            position: relative;
            width: 50px;
            height: 24px;
            margin-top: auto;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 24px;
            cursor: pointer;
            transition: .4s;
        }

        .slider:before {
            content: "";
            position: absolute;
            left: 3px;
            bottom: 3px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            transition: .4s;
        }

        input:checked+.slider {
            background-color: #BEA167;
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }

        main {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        section {
            background: #F5F1E8;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .1);
        }

        section h2 {
            margin: 0 0 10px 0;
            font-size: 1.2rem;
            color: #BEA167;
            border-bottom: 2px solid #BEA167;
        }

        label {
            display: block;
            margin-top: 12px;
            font-weight: bold;
        }

        input,
        select {
            width: calc(100% - 16px);
            padding: 8px;
            margin: 6px 0 14px 0;
            border-radius: 10px;
            border: 1px solid #ccc;
        }

        button {
            margin: 5px;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: #BEA167;
            color: #303030;
            font-weight: bold;
            cursor: pointer;
        }

        button:hover {
            background: #303030;
            color: #F5F1E8;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #303030;
            color: #F5F1E8;
        }

        #resultado {
            margin: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
        }

        .totales {
            text-align: right;
            margin-top: 15px;
        }

        #historial {
            margin: 20px;
            background: #F5F1E8;
            padding: 15px;
            border-radius: 10px;
        }

        #historial input {
            width: 100%;
            margin-bottom: 10px;
        }

        #lista_historial li {
            margin: 5px 0;
        }

        #lista_historial button {
            margin-left: 5px;
        }
    </style>
</head>

<body>
    <header>
        <span id="header_nombre">AXENTIA</span>
        <div class="switch-container">
            <span>AX</span>
            <label class="switch">
                <input type="checkbox" id="empresa_toggle" onchange="cambiarEmpresa()">
                <span class="slider"></span>
            </label>
            <span>MDP</span>
        </div>
    </header>

    <main>
        <!-- Empresa -->
        <section>
            <h2>Datos de la Empresa</h2>
            <label>Nombre</label>
            <input type="text" id="empresa_nombre" value="AXENTIA" readonly>
            <label>CUIT</label>
            <input type="text" id="empresa_cuit" value="30-71902891-4" readonly>
            <label>Dirección</label>
            <input type="text" id="empresa_direccion" value="Sarmiento 24" readonly>
            <label>Email</label>
            <input type="email" id="empresa_mail" value="adm.axentia@gmail.com" readonly>
            <label>Teléfono</label>
            <input type="text" id="empresa_tel" value="+54 9 3364 24-9663" readonly>
        </section>

        <!-- Cliente -->
        <section>
            <h2>Datos del Cliente</h2>
            <label>Nombre</label>
            <input type="text" id="cliente_nombre">
            <label>CUIT</label>
            <input type="text" id="cliente_cuit">
            <label>Dirección</label>
            <input type="text" id="cliente_direccion">
            <label>Email</label>
            <input type="email" id="cliente_mail">
        </section>

        <!-- Presupuesto -->
        <section>
            <h2>Datos del Presupuesto</h2>
            <label>Moneda</label>
            <select id="moneda" onchange="actualizarTabla(this.value)">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="ARS">ARS</option>
            </select>
            <label>Fecha</label>
            <input type="date" id="fecha">
            <label>Validez (días)</label>
            <input type="number" id="validez" min="1" placeholder="Ej: 30">
            <label>Forma de pago</label>
            <select id="pago">
                <option>Efectivo</option>
                <option>Cuenta Corriente</option>
                <option>Transferencia</option>
                <option>Cheque</option>
            </select>
        </section>
    </main>

    <section style="margin:20px;">
        <h2>Productos</h2>
        <input type="text" id="producto_desc" placeholder="Descripción">
        <input type="number" id="producto_cant" placeholder="Cantidad" min="1">
        <input type="number" id="producto_precio" placeholder="Precio unitario" step="0.01">
        <input type="number" id="producto_iva" placeholder="IVA (%)" value="10.5">
        <button onclick="agregarProducto()">Agregar producto</button>

        <table id="tabla_productos">
            <thead>
                <tr>
                    <th>Descripción</th>
                    <th>Cant</th>
                    <th>Precio Base</th>
                    <th>Sub-Tot Base</th>
                    <th>IVA (%)</th>
                    <th>Total IVA</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="totales">
            <h3>Total Neto: <span id="total">0</span> <span id="simbolo_moneda">USD</span></h3>
            <h3>Total IVA: <span id="iva_total">0</span> <span id="simbolo_moneda">USD</span></h3>
            <h2>Total Final: <span id="total_final">0</span> <span id="simbolo_moneda">USD</span></h2>
        </div>
    </section>

    <div style="text-align:center;">
        <button onclick="generarPresupuesto()">Generar Presupuesto</button>
        <button onclick="descargarPDF()">Descargar PDF</button>
    </div>

    <div id="resultado"></div>

    <!-- Historial -->
    <section id="historial">
        <h2>Historial de Presupuestos</h2>
        <input type="text" id="filtro_cliente" placeholder="Buscar por cliente..." onkeyup="mostrarHistorial()">
        <ul id="lista_historial"></ul>
    </section>

    <script>
        let productos = [];
        let historial = JSON.parse(localStorage.getItem("historialPresupuestos") || "[]");

        function cambiarEmpresa() {
            const toggle = document.getElementById("empresa_toggle");
            if (toggle.checked) {
                document.getElementById("header_nombre").innerText = "MDP SOLUCIONES";
                document.getElementById("empresa_nombre").value = "MDP SOLUCIONES";
                document.getElementById("empresa_cuit").value = "20-35023798-5";
            } else {
                document.getElementById("header_nombre").innerText = "AXENTIA";
                document.getElementById("empresa_nombre").value = "AXENTIA";
                document.getElementById("empresa_cuit").value = "30-71902891-4";
            }
        }

        function agregarProducto() {
            const desc = document.getElementById("producto_desc").value;
            const cant = parseInt(document.getElementById("producto_cant").value);
            const precio = parseFloat(document.getElementById("producto_precio").value);
            const ivaPorc = parseFloat(document.getElementById("producto_iva").value) || 0;
            const moneda = document.getElementById("moneda").value;
            if (!desc || isNaN(cant) || isNaN(precio)) return;
            const subTotalBase = cant * precio;
            const totalIVA = subTotalBase * ivaPorc / 100;
            productos.push({ desc, cant, precio, subTotalBase, ivaPorc, totalIVA });
            actualizarTabla(moneda);
            document.getElementById("producto_desc").value = "";
            document.getElementById("producto_cant").value = "";
            document.getElementById("producto_precio").value = "";
            document.getElementById("producto_iva").value = "10.5";
        }

        function actualizarTabla(moneda) {
            const tbody = document.querySelector("#tabla_productos tbody");
            tbody.innerHTML = "";
            let total = 0, totalIVA = 0;
            productos.forEach((p, i) => {
                total += p.subTotalBase; totalIVA += p.totalIVA;
                tbody.innerHTML += `
      <tr>
        <td>${p.desc}</td><td>${p.cant}</td><td>${p.precio.toFixed(2)} ${moneda}</td>
        <td>${p.subTotalBase.toFixed(2)} ${moneda}</td>
        <td>${p.ivaPorc}%</td><td>${p.totalIVA.toFixed(2)} ${moneda}</td>
        <td><button onclick="eliminarProducto(${i})">🗑</button></td>
      </tr>`;
            });
            const totalFinal = total + totalIVA;
            document.getElementById("total").innerText = total.toFixed(2);
            document.getElementById("iva_total").innerText = totalIVA.toFixed(2);
            document.getElementById("total_final").innerText = totalFinal.toFixed(2);
            document.querySelectorAll("#simbolo_moneda").forEach(el => el.innerText = moneda);
        }

        function eliminarProducto(i) {
            productos.splice(i, 1);
            actualizarTabla(document.getElementById("moneda").value);
        }

        function generarPresupuesto() {
            const empresa = {
                nombre: empresa_nombre.value, cuit: empresa_cuit.value,
                direccion: empresa_direccion.value, mail: empresa_mail.value, tel: empresa_tel.value
            };
            const cliente = {
                nombre: cliente_nombre.value, cuit: cliente_cuit.value,
                direccion: cliente_direccion.value, mail: cliente_mail.value
            };
            const presupuesto = {
                moneda: moneda.value, fecha: fecha.value, validez: validez.value, pago: pago.value,
                productos: [...productos],
                totales: {
                    neto: document.getElementById("total").innerText,
                    iva: document.getElementById("iva_total").innerText,
                    final: document.getElementById("total_final").innerText
                }
            };
            historial.push({ empresa, cliente, presupuesto });
            localStorage.setItem("historialPresupuestos", JSON.stringify(historial));
            mostrarHistorial();
            verPresupuesto(historial.length - 1);
        }

        function verPresupuesto(i) {
            const { empresa, cliente, presupuesto } = historial[i];
            let html = `<h2>Presupuesto</h2>
    <h3>Empresa</h3><p><strong>${empresa.nombre}</strong> (CUIT: ${empresa.cuit})<br>${empresa.direccion}<br>${empresa.mail} - ${empresa.tel}</p>
    <h3>Cliente</h3><p><strong>${cliente.nombre}</strong> (CUIT: ${cliente.cuit})<br>${cliente.direccion}<br>${cliente.mail}</p>
    <p><strong>Fecha:</strong> ${presupuesto.fecha}</p>
    <p><strong>Validez:</strong> ${presupuesto.validez} días</p>
    <p><strong>Forma de pago:</strong> ${presupuesto.pago}</p>
    <h3>Productos</h3>
    <table border="1" cellspacing="0" cellpadding="5">
      <tr><th>Descripción</th><th>Cant</th><th>Precio Base</th><th>Sub-Tot Base</th><th>IVA (%)</th><th>Total IVA</th></tr>`;
            presupuesto.productos.forEach(p => {
                html += `<tr><td>${p.desc}</td><td>${p.cant}</td><td>${p.precio.toFixed(2)} ${presupuesto.moneda}</td><td>${p.subTotalBase.toFixed(2)} ${presupuesto.moneda}</td><td>${p.ivaPorc}%</td><td>${p.totalIVA.toFixed(2)} ${presupuesto.moneda}</td></tr>`;
            });
            html += `</table><div class="totales"><p><strong>Total Neto:</strong> ${presupuesto.totales.neto} ${presupuesto.moneda}</p>
    <p><strong>Total IVA:</strong> ${presupuesto.totales.iva} ${presupuesto.moneda}</p>
    <p><strong>Total Final:</strong> ${presupuesto.totales.final} ${presupuesto.moneda}</p></div>`;
            document.getElementById("resultado").innerHTML = html;
        }

        function descargarPDF(i = null) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF(); const pageWidth = doc.internal.pageSize.width;
            let empresa, cliente, presupuesto;
            if (i === null) {
                empresa = {
                    nombre: empresa_nombre.value, cuit: empresa_cuit.value,
                    direccion: empresa_direccion.value, mail: empresa_mail.value, tel: empresa_tel.value
                };
                cliente = {
                    nombre: cliente_nombre.value, cuit: cliente_cuit.value,
                    direccion: cliente_direccion.value, mail: cliente_mail.value
                };
                presupuesto = {
                    moneda: moneda.value, fecha: fecha.value, validez: validez.value, pago: pago.value,
                    productos: [...productos],
                    totales: { neto: total.innerText, iva: iva_total.innerText, final: total_final.innerText }
                };
            } else { ({ empresa, cliente, presupuesto } = historial[i]); }
            doc.setFontSize(16);
            doc.text("Presupuesto", pageWidth / 2, 15, { align: "center" });
            doc.setFontSize(12);
            doc.text(`Empresa: ${empresa.nombre} (CUIT: ${empresa.cuit})`, 14, 30);
            doc.text(`${empresa.direccion}`, 14, 36);
            doc.text(`${empresa.mail} - ${empresa.tel}`, 14, 42);
            doc.text(`Cliente: ${cliente.nombre} (CUIT: ${cliente.cuit})`, 14, 54);
            doc.text(`${cliente.direccion}`, 14, 60);
            doc.text(`${cliente.mail}`, 14, 66);
            doc.text(`Fecha: ${presupuesto.fecha}`, 14, 78);
            doc.text(`Validez: ${presupuesto.validez} días`, 14, 84);
            doc.text(`Forma de pago: ${presupuesto.pago}`, 14, 90);
            doc.autoTable({
                startY: 100,
                head: [["Descripción", "Cant", "Precio Base", "Sub-Tot Base", "IVA (%)", "Total IVA"]],
                body: presupuesto.productos.map(p => [
                    p.desc, p.cant, p.precio.toFixed(2), p.subTotalBase.toFixed(2),
                    p.ivaPorc + "%", p.totalIVA.toFixed(2)
                ]),
                theme: "grid",
                headStyles: { fillColor: [48, 48, 48], textColor: [245, 241, 232] },
                alternateRowStyles: { fillColor: [249, 249, 249] }
            });
            const totales = [
                ["Total Neto:", presupuesto.totales.neto + " " + presupuesto.moneda],
                ["Total IVA:", presupuesto.totales.iva + " " + presupuesto.moneda],
                ["Total Final:", presupuesto.totales.final + " " + presupuesto.moneda]
            ];
            const tableWidth = Math.max(...totales.map(r => doc.getTextWidth(r[0] + " " + r[1]))) + 20;
            doc.autoTable({
                body: totales, startY: doc.lastAutoTable.finalY + 10,
                theme: "grid", tableWidth: "auto",
                margin: { left: pageWidth - tableWidth - 14 },
                styles: { halign: "right", cellPadding: 3 },
                bodyStyles: { fillColor: [245, 241, 232], textColor: [48, 48, 48] },
                didParseCell: function (data) {
                    if (data.row.index === 2) {
                        data.cell.styles.fillColor = [190, 161, 103];
                        data.cell.styles.textColor = [48, 48, 48];
                        data.cell.styles.fontStyle = "bold";
                    }
                }
            });
            doc.save(`Presupuesto_${cliente.nombre}.pdf`);
        }

        function mostrarHistorial() {
            const filtro = document.getElementById("filtro_cliente").value.toLowerCase();
            const lista = document.getElementById("lista_historial");
            lista.innerHTML = "";
            historial.forEach((h, i) => {
                if (!h.cliente.nombre.toLowerCase().includes(filtro)) return;
                const li = document.createElement("li");
                li.textContent = `${h.cliente.nombre} - ${h.presupuesto.fecha} `;
                const verBtn = document.createElement("button");
                verBtn.textContent = "👁 Ver"; verBtn.onclick = () => verPresupuesto(i);
                const pdfBtn = document.createElement("button");
                pdfBtn.textContent = "⬇ PDF"; pdfBtn.onclick = () => descargarPDF(i);
                const delBtn = document.createElement("button");
                delBtn.textContent = "🗑 Eliminar"; delBtn.onclick = () => {
                    if (confirm("¿Eliminar presupuesto?")) {
                        historial.splice(i, 1);
                        localStorage.setItem("historialPresupuestos", JSON.stringify(historial));
                        mostrarHistorial();
                    }
                };
                li.appendChild(verBtn); li.appendChild(pdfBtn); li.appendChild(delBtn);
                lista.appendChild(li);
            });
        }
        mostrarHistorial();
    </script>
</body>

</html>